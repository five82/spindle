# Spindle Configuration
# ====================
# Edit the REQUIRED settings below, then customize optional settings when needed.

# ============================================================================
# PATHS & STORAGE
# ============================================================================

[paths]
staging_dir = "~/.local/share/spindle/staging"       # Working directory for rips/encodes
library_dir = "~/your-media-library"                 # MUST EXIST: Final media library directory
log_dir = "~/.local/share/spindle/logs"              # Logs and queue database
review_dir = "~/review"                              # Files needing manual attention (uncertain metadata, etc.)
opensubtitles_cache_dir = "~/.local/share/spindle/cache/opensubtitles"
whisperx_cache_dir = "~/.local/share/spindle/cache/whisperx"
api_bind = "127.0.0.1:7487"                          # HTTP API bind address (use 0.0.0.0:7487 for remote access)
api_token = ""                                       # Bearer token for API auth (or set SPINDLE_API_TOKEN env var)

# ============================================================================
# TMDB & METADATA (required for media identification)
# ============================================================================

[tmdb]
api_key = "your_tmdb_api_key_here"                   # Get from themoviedb.org/settings/api
language = "en-US"                                   # ISO 639-1 language for TMDB metadata
base_url = "https://api.themoviedb.org/3"            # Override when using a TMDB proxy

# ============================================================================
# LIBRARY STRUCTURE
# ============================================================================

[library]
movies_dir = "movies"                                # Subdirectory inside library_dir for movies
tv_dir = "tv"                                        # Subdirectory inside library_dir for TV
overwrite_existing = false                           # Set true to replace existing MKV/SRT files

# ============================================================================
# JELLYFIN INTEGRATION
# ============================================================================

[jellyfin]
enabled = false                                      # If false, Spindle will not trigger Jellyfin scans
url = "http://localhost:8096"                        # Jellyfin server URL
api_key = "your_jellyfin_api_key"                    # Jellyfin API key (create in the admin dashboard)

# ============================================================================
# NOTIFICATIONS
# ============================================================================

[notifications]
ntfy_topic = "https://ntfy.sh/your_topic"            # ntfy topic for push notifications (optional)
request_timeout = 10                                 # ntfy HTTP client timeout (seconds)
identification = true                                # Send identification success notifications
rip = true                                           # Send rip completion notifications
encoding = true                                      # Send encoding completion notifications
validation = true                                    # Send validation failure notifications
organization = true                                  # Send library/organizer completion notifications
queue = true                                         # Send queue start/finish notifications
review = true                                        # Send notifications when item sent to review_dir
errors = true                                        # Always notify on errors when true
min_rip_seconds = 120                                # Suppress rip notifications for fast cache hits
queue_min_items = 2                                  # Minimum items for queue start/finish notices
dedup_window_seconds = 600                           # De-duplicate identical notifications (seconds)

# ============================================================================
# SUBTITLES
# ============================================================================

[subtitles]
enabled = false                                      # Enable WhisperX subtitle generation after encoding
mux_into_mkv = true                                  # Embed subtitles into MKV container (requires mkvmerge)
whisperx_model = "large-v3"                          # Whisper model: "large-v3" (best) or "large-v3-turbo" (faster)
whisperx_cuda_enabled = false                        # Run WhisperX with CUDA; set true when GPU available
whisperx_vad_method = "silero"                       # Voice activity detector: "silero" or "pyannote"
whisperx_hf_token = ""                               # Hugging Face token for pyannote VAD (optional)
opensubtitles_enabled = false                        # Fetch subtitles from OpenSubtitles first
opensubtitles_api_key = "your_opensubtitles_api_key" # Required when opensubtitles_enabled is true
opensubtitles_user_agent = "Spindle/<version>"       # Custom User-Agent for OpenSubtitles
opensubtitles_user_token = ""                        # Optional OpenSubtitles user JWT
opensubtitles_languages = ["en"]                     # Preferred subtitle languages (ISO 639-1)

# ============================================================================
# RIP CACHE (optional)
# ============================================================================

[rip_cache]
enabled = false                                      # Keep copies of ripped files
dir = "~/.cache/spindle/rips"                        # Defaults to XDG_CACHE_HOME/spindle/rips
max_gib = 150                                        # Cache budget in GiB

# ============================================================================
# DISC ID CACHE (optional)
# ============================================================================

[disc_id_cache]
enabled = false                                      # Cache disc ID to TMDB ID mappings
path = "~/.cache/spindle/discid_cache.json"          # Cache file location

# ============================================================================
# MAKEMKV & DISC RIPPING
# ============================================================================

[makemkv]
optical_drive = "/dev/sr0"                           # Optical drive device path
rip_timeout = 14400                                  # MakeMKV ripping timeout (seconds, 4 hours for 4K UHD)
info_timeout = 600                                   # MakeMKV disc info timeout (seconds, 10 min default)
disc_settle_delay = 10                               # Seconds to wait between disc access commands (0 disables)
min_title_length = 120                               # Skip titles shorter than N seconds (0 disables)
keydb_path = "~/.config/spindle/keydb/KEYDB.cfg"     # Optional KEYDB.cfg for Disc ID lookups
keydb_download_url = "http://fvonline-db.bplaced.net/export/keydb_eng.zip"
keydb_download_timeout = 1500                        # Download timeout in seconds

# ============================================================================
# ENCODING (Drapto AV1 encoding)
# ============================================================================

[encoding]
svt_av1_preset = 6                                      # SVT-AV1 speed preset (0-13, lower = slower/better quality)

# ============================================================================
# LLM (shared settings for AI-powered features)
# ============================================================================

[llm]
api_key = ""                                         # OpenRouter API key (or set OPENROUTER_API_KEY env var)
base_url = "https://openrouter.ai/api/v1/chat/completions"
model = "google/gemini-3-flash-preview"             # OpenRouter model identifier
referer = "https://github.com/five82/spindle"        # Sent to OpenRouter for routing/analytics
title = "Spindle"                                    # Display name sent via X-Title header
timeout_seconds = 60                                 # HTTP timeout (seconds)

# ============================================================================
# COMMENTARY DETECTION (audio analysis to identify commentary tracks)
# ============================================================================

[commentary]
enabled = false                                      # Enable commentary track detection during ripping
whisperx_model = "large-v3-turbo"                    # Whisper model for transcription (defaults to subtitles model)
similarity_threshold = 0.92                          # Cosine similarity above which track is a stereo downmix (not commentary)
confidence_threshold = 0.80                          # LLM confidence required to classify as commentary
# LLM settings - if not set, falls back to [llm] settings above
# api_key = ""
# base_url = ""
# model = ""

# ============================================================================
# EPISODE IDENTIFICATION POLICY (advanced tuning)
# ============================================================================

[content_id]
min_similarity_score = 0.58                          # Base transcript similarity floor for accepting a match
low_confidence_review_threshold = 0.70               # Matches below this are flagged for review
llm_verify_threshold = 0.85                          # Matches below this are sent to LLM verification
anchor_min_score = 0.63                              # Minimum score for anchor-window selection
anchor_min_score_margin = 0.03                       # Minimum margin over second-best anchor score
block_high_confidence_delta = 0.05                   # High-confidence block window around top match score
block_high_confidence_top_ratio = 0.70               # Alternate high-confidence cutoff ratio (top N%)
disc_block_padding_min = 2                           # Minimum episode padding around disc-window estimates
disc_block_padding_divisor = 4                       # Dynamic padding divisor based on episodes-per-disc
disc1_must_start_at_episode1 = true                  # Enforce Disc 1 block start at episode 1
disc2_plus_min_start_episode = 2                     # Minimum block start for Disc 2+ assumptions

# ============================================================================
# WORKFLOW TUNING
# ============================================================================

[workflow]
queue_poll_interval = 5                              # Queue polling cadence (seconds)
error_retry_interval = 10                            # Delay before retrying failures (seconds)
heartbeat_interval = 15                              # Worker heartbeat interval (seconds)
heartbeat_timeout = 120                              # Worker heartbeat timeout (seconds)
disc_monitor_timeout = 5                             # Disc monitor polling timeout (seconds)

# ============================================================================
# LOGGING
# ============================================================================

[logging]
format = "console"                                   # "console" or "json"
level = "info"                                       # info, debug, warn, error
retention_days = 60                                  # Prune logs older than this (0 disables)

[logging.stage_overrides]                            # Per-stage log level overrides
# subtitles = "debug"

# ============================================================================
# VALIDATION
# ============================================================================

[validation]
enforce_drapto_validation = true                     # Fail encoding if Drapto validation fails
min_vote_count_exact_match = 5                       # TMDB vote threshold for high-confidence matches
