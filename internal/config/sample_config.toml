# Spindle Configuration
# ====================
# Edit the REQUIRED settings below, then customize optional settings when needed.

# ============================================================================
# PATHS & STORAGE
# ============================================================================

[paths]
staging_dir = "~/.local/share/spindle/staging"       # Working directory for rips/encodes
library_dir = "~/your-media-library"                 # MUST EXIST: Final media library directory
log_dir = "~/.local/share/spindle/logs"              # Logs and queue database
review_dir = "~/review"                              # Encoded files awaiting manual identification
opensubtitles_cache_dir = "~/.local/share/spindle/cache/opensubtitles"
whisperx_cache_dir = "~/.local/share/spindle/cache/whisperx"
api_bind = "127.0.0.1:7487"                          # HTTP API bind address (host:port)

# ============================================================================
# TMDB & METADATA (required for media identification)
# ============================================================================

[tmdb]
api_key = "your_tmdb_api_key_here"                   # Get from themoviedb.org/settings/api
language = "en-US"                                   # ISO 639-1 language for TMDB metadata
base_url = "https://api.themoviedb.org/3"            # Override when using a TMDB proxy
confidence_threshold = 0.8                           # Match confidence (0.0-1.0)

# ============================================================================
# LIBRARY STRUCTURE
# ============================================================================

[library]
movies_dir = "movies"                                # Subdirectory inside library_dir for movies
tv_dir = "tv"                                        # Subdirectory inside library_dir for TV
overwrite_existing = false                           # Set true to replace existing MKV/SRT files

# ============================================================================
# JELLYFIN INTEGRATION
# ============================================================================

[jellyfin]
enabled = false                                      # If false, Spindle will not trigger Jellyfin scans
url = "http://localhost:8096"                        # Jellyfin server URL
api_key = "your_jellyfin_api_key"                    # Jellyfin API key (create in the admin dashboard)

# ============================================================================
# NOTIFICATIONS
# ============================================================================

[notifications]
ntfy_topic = "https://ntfy.sh/your_topic"            # ntfy topic for push notifications (optional)
request_timeout = 10                                 # ntfy HTTP client timeout (seconds)
identification = true                                # Send identification success notifications
rip = true                                           # Send rip completion notifications
encoding = true                                      # Send encoding completion notifications
organization = true                                  # Send library/organizer completion notifications
queue = true                                         # Send queue start/finish notifications
review = true                                        # Send notifications when item sent to review_dir
errors = true                                        # Always notify on errors when true
min_rip_seconds = 120                                # Suppress rip notifications for fast cache hits
queue_min_items = 2                                  # Minimum items for queue start/finish notices
dedup_window_seconds = 600                           # De-duplicate identical notifications (seconds)

# ============================================================================
# SUBTITLES
# ============================================================================

[subtitles]
enabled = false                                      # Enable WhisperX subtitle generation after encoding
whisperx_cuda_enabled = false                        # Run WhisperX with CUDA; set true when GPU available
whisperx_vad_method = "silero"                       # Voice activity detector: "silero" or "pyannote"
whisperx_hf_token = ""                               # Hugging Face token for pyannote VAD (optional)
opensubtitles_enabled = false                        # Fetch subtitles from OpenSubtitles first
opensubtitles_api_key = "your_opensubtitles_api_key" # Required when opensubtitles_enabled is true
opensubtitles_user_agent = "Spindle/<version>"       # Custom User-Agent for OpenSubtitles
opensubtitles_user_token = ""                        # Optional OpenSubtitles user JWT
opensubtitles_languages = ["en"]                     # Preferred subtitle languages (ISO 639-1)

# ============================================================================
# COMMENTARY DETECTION
# ============================================================================

[commentary_detection]
enabled = true                                       # Detect and keep commentary audio tracks
languages = ["en"]                                   # Strict language filter for commentary candidates
channels = 2                                         # Channel count required for commentary candidates
sample_windows = 3                                   # Windows sampled across the program
window_seconds = 90                                  # Seconds per sample window
fingerprint_similarity_duplicate = 0.98              # Similarity threshold for duplicate/downmix exclusion
speech_ratio_min_commentary = 0.25                   # Minimum speech ratio for commentary inclusion
speech_ratio_max_music = 0.10                        # Maximum speech ratio for music-only exclusion
speech_overlap_primary_min = 0.60                    # Minimum overlap for mixed commentary inclusion
speech_overlap_primary_max_audio_description = 0.30  # Max overlap for audio-description exclusion
speech_in_silence_max = 0.40                         # Max allowed speech in primary silence (AD exclusion)
duration_tolerance_seconds = 120                     # Absolute duration tolerance vs primary (seconds)
duration_tolerance_ratio = 0.02                      # Relative duration tolerance vs primary (ratio)

# ============================================================================
# RIP CACHE (optional)
# ============================================================================

[rip_cache]
enabled = false                                      # Keep copies of ripped files
dir = "~/.cache/spindle/rips"                        # Defaults to XDG_CACHE_HOME/spindle/rips
max_gib = 150                                        # Cache budget in GiB

# ============================================================================
# MAKEMKV & DISC RIPPING
# ============================================================================

[makemkv]
optical_drive = "/dev/sr0"                           # Optical drive device path
rip_timeout = 3600                                   # MakeMKV ripping timeout (seconds)
info_timeout = 300                                   # MakeMKV disc info timeout (seconds)
keydb_path = "~/.config/spindle/keydb/KEYDB.cfg"     # Optional KEYDB.cfg for Disc ID lookups
keydb_download_url = "http://fvonline-db.bplaced.net/export/keydb_eng.zip"
keydb_download_timeout = 1500                        # Download timeout in seconds
identification_overrides_path = "~/.config/spindle/overrides/identification.json"

# ============================================================================
# PRESET DECIDER (LLM-based encoding preset selection)
# ============================================================================

[preset_decider]
enabled = false                                      # Use LLM to choose Drapto presets per title
api_key = ""                                         # Required when enabled; or set OPENROUTER_API_KEY
base_url = "https://openrouter.ai/api/v1/chat/completions"
model = "google/gemini-3-flash-preview"             # OpenRouter model identifier
referer = "https://github.com/five82/spindle"        # Sent to OpenRouter for routing/analytics
title = "Spindle Preset Decider"                     # Display name sent via X-Title header
timeout_seconds = 60                                 # HTTP timeout (seconds)

# ============================================================================
# WORKFLOW TUNING
# ============================================================================

[workflow]
queue_poll_interval = 5                              # Queue polling cadence (seconds)
error_retry_interval = 10                            # Delay before retrying failures (seconds)
heartbeat_interval = 15                              # Worker heartbeat interval (seconds)
heartbeat_timeout = 120                              # Worker heartbeat timeout (seconds)
disc_monitor_timeout = 5                             # Disc monitor polling timeout (seconds)

# ============================================================================
# LOGGING
# ============================================================================

[logging]
format = "console"                                   # "console" or "json"
level = "info"                                       # info, debug, warn, error
retention_days = 60                                  # Prune logs older than this (0 disables)

[logging.stage_overrides]                            # Per-stage log level overrides
# subtitles = "debug"
